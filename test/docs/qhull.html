<!DOCTYPE html>  <html> <head>   <title>qhull.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               qhull.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>qhull.coffee</strong> is a prototype quickhull implementation
in plasm.js, 
the <em>JavaScript Programming Language for Solid Modeling</em></p>

<p>Copyright (c) 2011-2012 Universit Roma Tre, CVD-lab <a href="&#109;&#97;&#x69;&#x6C;&#116;&#111;:&#x63;&#x76;&#100;&#x6C;&#97;&#98;&#x40;&#101;&#109;a&#105;&#108;&#x2E;&#99;o&#x6D;">&#x63;&#x76;&#100;&#x6C;&#97;&#98;&#x40;&#101;&#109;a&#105;&#108;&#x2E;&#99;o&#x6D;</a></p>

<p>The source for <a href="https://github.com/cvd-lab/">Plasm.js</a> is available on GitHub,
and released under the MIT license.
<HR></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Internet RGB colors (normalized)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">WHITE	= </span><span class="p">[</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>
<span class="nv">SILVER 	= </span><span class="p">[</span> <span class="mf">0.8</span> <span class="p">,</span> <span class="mf">0.8</span> <span class="p">,</span> <span class="mf">0.8</span> <span class="p">]</span>
<span class="nv">GRAY 	= </span><span class="p">[</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">]</span>
<span class="nv">BLACK 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">RED 	= </span><span class="p">[</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">MAROON 	= </span><span class="p">[</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">YELLOW 	= </span><span class="p">[</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">OLIVE 	= </span><span class="p">[</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">LIME 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">GREEN 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">]</span>
<span class="nv">AQUA 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>
<span class="nv">TEAL 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">]</span>
<span class="nv">BLUE 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>
<span class="nv">NAVY 	= </span><span class="p">[</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">]</span>
<span class="nv">FUCHSIA	= </span><span class="p">[</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>
<span class="nv">PURPLE 	= </span><span class="p">[</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mf">0.0</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Internet color names</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">palette = </span><span class="p">[</span><span class="nx">MAROON</span><span class="p">,</span> <span class="nx">RED</span><span class="p">,</span> <span class="nx">LIME</span><span class="p">,</span> <span class="nx">BLUE</span><span class="p">,</span> <span class="nx">AQUA</span><span class="p">,</span> <span class="nx">FUCHSIA</span><span class="p">,</span> <span class="nx">YELLOW</span><span class="p">,</span> <span class="nx">WHITE</span><span class="p">,</span> <span class="nx">SILVER</span><span class="p">,</span> 
			<span class="nx">GRAY</span><span class="p">,</span> <span class="nx">BLACK</span><span class="p">,</span> <span class="nx">OLIVE</span><span class="p">,</span> <span class="nx">GREEN</span><span class="p">,</span> <span class="nx">TEAL</span><span class="p">,</span> <span class="nx">NAVY</span><span class="p">,</span> <span class="nx">PURPLE</span><span class="p">]</span>
	</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Conversion from <em>decimal</em> (basis 10) to <em>hexatridecimal</em> (basis 36) numerals</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">d2h = </span><span class="nf">(d) -&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">toString</span> <span class="mi">36</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Inverse conversion from <em>hexatridecimal</em> to <em>decimal</em> numeral basis</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">h2d = </span><span class="nf">(h) -&gt;</span> <span class="nb">parseInt</span> <span class="nx">h</span><span class="p">,</span><span class="mi">36</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Used to concatenate a numeral <code>key</code> with an array <code>keys</code> of numerals.
Return an array of composite numerals.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">keysConcat = </span><span class="nf">(key,keys) -&gt;</span> <span class="p">((</span><span class="nx">pair</span><span class="p">.</span><span class="nx">join</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">pair</span> <span class="k">in</span> <span class="nx">DISTL</span><span class="p">([</span><span class="nx">key</span><span class="p">,</span> <span class="nx">keys</span><span class="p">]))</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>To produce a random set of points within the interval space [0, <code>scale</code>]^<code>rn</code>.
Return a <code>PointSet</code> instance made by <code>m</code> points, each with <code>rn</code> coordinates.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomPoints = </span><span class="nf">(rn=2,m=40,scale=2) -&gt;</span>
	<span class="k">new</span> <span class="nx">PointSet</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">scale</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">rn</span><span class="p">]</span> <span class="k">for</span> <span class="nx">point</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">m</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>To generate the <em>square matrix</em> of a (solid) simplex in homogeneous coordinates.
The homogeneous coordinate (the last one) is set to one. If the input <code>cell</code>
is not degenerate, the determinant of this matrix is non-zero.
Return a list of lists of numbers, taken from the coordinate list <code>verts</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">simplexMatrix = </span><span class="nf">(verts,cell) -&gt;</span> <span class="p">(</span><span class="nx">AR</span> <span class="p">[</span><span class="nx">verts</span><span class="p">[</span><span class="nx">k</span><span class="p">],</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">cell</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>To compute the "grade" of a point in affine coordinates.
Return a hexatridecimal number (<em>d+1</em> bits) that gives a classification of a
<em>d</em>-point (affine coordinates) in the proper <em>"tiling"</em> of <em>d</em>-space.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">grading = </span><span class="nf">(point) -&gt;</span>
	<span class="nv">grade = </span><span class="nf">(x) -&gt;</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="k">then</span> <span class="s1">&#39;1&#39;</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span>
	<span class="nv">binaryDigits = </span><span class="nx">AA</span><span class="p">(</span><span class="nx">grade</span><span class="p">)(</span><span class="nx">point</span><span class="p">).</span><span class="nx">join</span> <span class="s2">&quot;&quot;</span>
	<span class="nx">d2h</span> <span class="nb">parseInt</span> <span class="nx">binaryDigits</span><span class="p">,</span><span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The matrix of a change of coordinates is computed. The <code>mapping</code> function 
transforms the vectors in <code>basis</code>
into the standard orthonormal frame. The matrix inversion is done only if 
the input <code>basis</code> vectors are linearly independent (<em>det basis ≠ 0</em>).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">mapping = </span><span class="nf">(basis) -&gt;</span> <span class="k">if</span> <span class="nx">numeric</span><span class="p">.</span><span class="nx">det</span> <span class="nx">basis</span> <span class="k">then</span> <span class="nx">numeric</span><span class="p">.</span><span class="nx">inv</span> <span class="nx">basis</span> <span class="k">else</span> <span class="nx">basis</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>To compute the affine coordinates (w.r.t. a reference simplex) of an array of 
Cartesian points. The input matrix is <em>d+1 x d+1</em>. The input <code>cartesianPoints</code> 
have <em>d</em> coordinates; the output <code>affinePoints</code> have <em>d+1</em> coordinates.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">affineMapping = </span><span class="nf">(matrix) -&gt;</span> <span class="nf">(cartesianPoints) -&gt;</span>
	<span class="nv">homogeneousPoints = </span><span class="p">(</span><span class="nx">AR</span> <span class="p">[</span><span class="nx">point</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="nx">point</span> <span class="k">in</span> <span class="nx">cartesianPoints</span><span class="p">)</span>
	<span class="nv">affinePoints = </span><span class="nx">numeric</span><span class="p">.</span><span class="nx">dot</span><span class="p">(</span><span class="nx">homogeneousPoints</span><span class="p">,</span> <span class="nx">matrix</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Used to check wheter the area of the reference simplex (in Cartesian space) is too small.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">closetozero = </span><span class="nf">(number) -&gt;</span> <span class="k">if</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">number</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="nx">E</span><span class="o">-</span><span class="mi">2</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>A random <code>d</code>-simplex of area not too small is generated. The <code>cell</code> array, that contains
<em>d+1</em> integer references to <code>verts</code> is returned`. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">randomSimplex = </span><span class="nf">(verts,d) -&gt;</span>
	<span class="nv">isSquare = </span><span class="nf">(mat) -&gt;</span> <span class="k">if</span> <span class="nx">mat</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="nx">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="k">then</span> <span class="kc">true</span> <span class="k">else</span> <span class="kc">false</span>
	<span class="p">[</span><span class="nx">cell</span><span class="p">,</span><span class="nx">m</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="nx">verts</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
	<span class="k">while</span> <span class="nx">cell</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="nx">d</span>
		<span class="nv">index = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">m</span><span class="p">)</span>
		<span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">index</span> <span class="k">in</span> <span class="nx">cell</span><span class="p">)</span> <span class="k">then</span> <span class="nx">cell</span><span class="p">.</span><span class="nx">push</span> <span class="nx">index</span>
		<span class="nv">mat = </span><span class="nx">simplexMatrix</span><span class="p">(</span><span class="nx">verts</span><span class="p">,</span><span class="nx">cell</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cell</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">d</span><span class="o">+</span><span class="mi">1</span> <span class="o">and</span> <span class="nx">isSquare</span><span class="p">(</span><span class="nx">mat</span><span class="p">)</span> <span class="o">and</span> <span class="nx">closetozero</span><span class="p">(</span><span class="nx">numeric</span><span class="p">.</span><span class="nx">det</span><span class="p">(</span><span class="nx">mat</span><span class="p">))</span>
			<span class="nv">cell = </span><span class="p">[]</span>
	<span class="nx">cell</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>To extract a reference simplex from an array of <code>points</code>.
Return a partition of the set into a dictionary with <em>(2^d)-1</em> <code>buckets</code> of `<em>close</em> points,
i.e. of points within the same region of the partition of space.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">spacePartition = </span><span class="nf">(points) -&gt;</span>
	<span class="nv">d = </span><span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span>
	<span class="nv">m = </span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span>
	<span class="nv">referenceCell = </span><span class="nx">randomSimplex</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="nx">d</span><span class="p">)</span>
	<span class="nv">referenceSimplex = </span><span class="nx">simplexMatrix</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span><span class="nx">referenceCell</span><span class="p">)</span>
	<span class="nv">matrix = </span><span class="nx">mapping</span><span class="p">(</span><span class="nx">referenceSimplex</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>All points are transformed to affine coordinates and all their <code>tokens</code> are computed</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">tokens = </span><span class="nx">AA</span><span class="p">(</span><span class="nx">grading</span><span class="p">)(</span><span class="nx">affineMapping</span><span class="p">(</span><span class="nx">matrix</span><span class="p">)(</span><span class="nx">points</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>All <code>buckets</code> are initialized: keys to the (hexatridecimal) token; values to the empty array.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">buckets = </span><span class="p">{};</span> <span class="nx">buckets</span><span class="p">[</span><span class="nx">d2h</span> <span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">d</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>All points are inserted in the right bucket in (near) linear time: <em>O(m log d)</em>, with <em>m >>> d</em></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">m</span><span class="p">]</span>
		<span class="k">if</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">points</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">buckets</span><span class="p">[</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">k</span><span class="p">]]</span><span class="o">?</span>
			<span class="nx">buckets</span><span class="p">[</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">k</span><span class="p">]].</span><span class="nx">push</span> <span class="nx">points</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The transformation <code>matrix</code> of <code>points</code> from Cartesian to affine coordinates 
is also returned, to be possibly used for computing the zetta-token of a (first) query point.  TODO</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="p">[</span><span class="nx">buckets</span><span class="p">,</span><span class="nx">matrix</span><span class="p">]</span> </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Main preprocessing function. To compute the point <code>Buckets</code> dictionary indexed by <strong>zettatoken</strong> keys of any length.
The input is an array <code>pointSet</code> of points and their dimension <code>d</code>.
Each bucket will finally contain no more than <em>(<code>d</code>+1) x <code>pointQuantity</code></em> points.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">makeRegionDict = </span><span class="nf">(pointSet, d, pointQuantity=30) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>To merge two dictionaries <code>obj1</code> and <code>obj2</code> by writing in <code>obj1</code>, for each value of <code>key</code> in <code>obj2</code>, the corresponding value.
Finally, the updated <code>obj1</code> is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">merge = </span><span class="nf">(obj1,obj2) -&gt;</span> 
		<span class="nx">obj1</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj2</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">obj2</span>
		<span class="nx">obj1</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>A first <code>spacePartition</code> call is executed on the input <code>pointSet</code>, and the initial <code>currentBuckets</code> are returned</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="p">[</span><span class="nx">currentBuckets</span><span class="p">,</span><span class="nx">theMap</span><span class="p">]</span> <span class="o">=</span> <span class="nx">spacePartition</span><span class="p">(</span><span class="nx">pointSet</span><span class="p">)</span> 
	<span class="nv">tosplit = </span><span class="kc">true</span>
	<span class="k">while</span> <span class="nx">tosplit</span>
		<span class="nv">tosplit = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>In each cycle, the output variable <code>Buckets</code> is re-initialized to the empty dictionary. </p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">Buckets = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>For each region (i.e. <code>key</code>) of the current partition (i.e. <code>currentBuckets</code>), do</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">currentBuckets</span>
			<span class="nv">newBucket = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>The region is going to be splitted if it contains too many points</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span> <span class="nx">currentBuckets</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">d</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nx">pointQuantity</span>
				<span class="nv">tosplit = </span><span class="kc">true</span>
				<span class="nv">points = </span><span class="nx">CLONE</span> <span class="nx">currentBuckets</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
				<span class="p">[</span><span class="nx">buckets</span><span class="p">,</span><span class="nx">theMap</span><span class="p">]</span> <span class="o">=</span> <span class="nx">spacePartition</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>The new tokens in each <code>newBucket</code> are build</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="nv">keys = </span><span class="p">(</span><span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">buckets</span><span class="p">)</span>
				<span class="nv">newKeys = </span><span class="nx">keysConcat</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="nx">keys</span><span class="p">)</span>
				<span class="nx">newBucket</span><span class="p">[</span><span class="nx">newKeys</span><span class="p">[</span><span class="nx">k</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">buckets</span><span class="p">[</span><span class="nx">keys</span><span class="p">[</span><span class="nx">k</span><span class="p">]]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
				<span class="nx">merge</span><span class="p">(</span><span class="nx">Buckets</span><span class="p">,</span><span class="nx">newBucket</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Add a zero symbol to the region <code>key</code> if the region is not splitted</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">else</span> 
				<span class="k">if</span> <span class="nx">currentBuckets</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
					<span class="nv">newKey = </span><span class="nx">keysConcat</span><span class="p">(</span><span class="nx">key</span><span class="p">,[</span><span class="s2">&quot;0&quot;</span><span class="p">])</span>
					<span class="nx">Buckets</span><span class="p">[</span><span class="nx">newKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">currentBuckets</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>At the end of each cycle the current <code>Buckets</code>  is cloned into <code>currentBuckets</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nv">currentBuckets = </span><span class="nx">CLONE</span> <span class="nx">Buckets</span>
	<span class="nx">Buckets</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p><HR></p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>Preview</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Used to accumulate a graphics primitive in <code>object</code> for each <code>points</code> array. The default primitive is 
<code>POLYLINE</code>. Other possible values for <code>primitive</code> are <code>"TRIANGLESTRIP"</code> or <code>"POLYMARKER"</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">preview  = </span><span class="nf">(points, object, primitive=&quot;POLYLINE&quot;) -&gt;</span>
	<span class="nv">n = </span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span>
	<span class="k">if</span> <span class="nx">primitive</span> <span class="o">is</span> <span class="s2">&quot;POLYMARKER&quot;</span> <span class="k">then</span> <span class="nx">object</span><span class="p">.</span><span class="nx">push</span> <span class="nx">POLYMARKER</span> <span class="nx">points</span>
	<span class="k">else</span> <span class="k">if</span> <span class="nx">primitive</span> <span class="o">is</span> <span class="s2">&quot;TRIANGLESTRIP&quot;</span> <span class="o">and</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">2</span> 
		<span class="nx">object</span><span class="p">.</span><span class="nx">push</span> <span class="nx">TRIANGLESTRIP</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
	<span class="k">else</span> <span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span>
		<span class="nx">object</span><span class="p">.</span><span class="nx">push</span> <span class="nx">POLYLINE</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
	<span class="k">else</span> 
		<span class="nx">object</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">SimplicialComplex</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">AA</span><span class="p">(</span><span class="nx">LIST</span><span class="p">)([</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]))</span>
	<span class="nx">object</span>
	</pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h1>Execution tests</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>3D example</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Execution initialization.
The parameter <code>rn</code> is the dimension of the point space.
Set <code>rn</code> to 2 for a 2D example.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">rn = </span><span class="mi">3</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p><code>points</code> to be classified are randomly generated, and their cuboidal space is centered about the origin
via the translation method <code>.t()</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">points = </span><span class="nx">randomPoints</span><span class="p">(</span><span class="nx">rn</span><span class="p">,</span> <span class="nx">m</span><span class="o">=</span><span class="mi">2000</span><span class="o">*</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">rn</span><span class="p">),</span> <span class="nx">scale</span><span class="o">=</span><span class="mi">8</span><span class="p">).</span><span class="nx">t</span><span class="p">(</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">rn</span><span class="p">],</span> <span class="nx">REPEAT</span><span class="p">(</span><span class="nx">rn</span><span class="p">)(</span><span class="o">-</span><span class="nx">scale</span><span class="err">/2) )</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>The <code>object</code> to draw is initialized to the empty array</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">object = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>A multi-level partition is generated here:</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Bucket = </span><span class="nx">makeRegionDict</span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">verts</span><span class="p">,</span> <span class="nx">rn</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>For each  <code>Bucket</code> of points a graphics primitive (i.e. a simplicial complex) is accumulated 
within the <code>object</code> array</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">Bucket</span>
	<span class="k">if</span> <span class="nx">Bucket</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span> <span class="o">and</span> <span class="nx">Bucket</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> 
		<span class="nx">preview</span><span class="p">(</span><span class="nx">Bucket</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">primitive</span><span class="o">=</span><span class="s2">&quot;POLYMARKER&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>The <code>draw</code> method of the <code>viewer</code> is applied to the <code>object</code> array, producing a <code>model</code> array. </p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">model = </span><span class="nx">viewer</span><span class="p">.</span><span class="nx">draw</span> <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Each simplicial complex in the <code>model</code> array is colored with a <code>color</code> in a <code>palette</code> of 16 colors</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">model</span><span class="p">[</span><span class="nx">k</span><span class="p">].</span><span class="nx">color</span> <span class="nx">palette</span><span class="p">[</span><span class="nx">k</span> <span class="o">%</span> <span class="mi">15</span><span class="p">]</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">model</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 